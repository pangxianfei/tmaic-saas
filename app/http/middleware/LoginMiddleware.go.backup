package middleware

import (
	"gitee.com/pangxianfei/framework/helpers/debug"
	"github.com/kataras/iris/v12"
	"github.com/kataras/iris/v12/context"
	"github.com/kataras/iris/v12/middleware/jwt"
	UserAppModel "tmaic/app/UserApp/model"
	"tmaic/app/UserApp/services"
	"tmaic/app/http/middleware/response"
)

var Login context.Handler

func initUserInfo() {
	Login = func(ctx iris.Context) {

		claims := jwt.Get(ctx).(*UserAppModel.Token)
		standardClaims := jwt.GetVerifiedToken(ctx).StandardClaims
		expiresAtString := standardClaims.ExpiresAt().Format(ctx.Application().ConfigurationReadOnly().GetTimeFormat())
		timeLeft := standardClaims.Timeleft()
		debug.Dd(claims.Mobile)
		debug.Dd(expiresAtString)
		debug.Dd(timeLeft)

		newUser := services.UserTokenService.GetUserInfo(ctx)
		if newUser == nil {
			_ = ctx.JSON(response.ErrorTokenInvalidation())
			return
		}
		ctx.Values().Set("UserInfo", newUser)
		ctx.Next()
	}
}
